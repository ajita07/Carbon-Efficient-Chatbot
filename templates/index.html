<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Carbon-Efficient Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar for Carbon Stats -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-leaf"></i> Carbon Dashboard</h3>
            </div>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="total-queries">0</span>
                        <span class="stat-label">Total Queries</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-smog"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="total-emissions">0.000000</span>
                        <span class="stat-label">Total CO‚ÇÇ (kg)</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-tree"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="trees-equivalent">0.00</span>
                        <span class="stat-label">Trees Needed</span>
                    </div>
                </div>
            </div>
            
            <div class="carbon-tips">
                <h4><i class="fas fa-lightbulb"></i> Eco Tips</h4>
                <ul>
                    <li>Short queries use less energy</li>
                    <li>Batch related questions together</li>
                    <li>Use precise language</li>
                    <li>Close unused AI applications</li>
                </ul>
            </div>
        </div>

        <!-- Main Chat Area (Same structure, enhanced styling) -->
        <div class="main-content">
            <div class="chat-header">
                <h2><i class="fas fa-robot"></i> Carbon-Efficient GenAI Chatbot</h2>
                <div class="header-stats">
                    <span class="live-indicator">
                        <i class="fas fa-circle"></i> Live CO‚ÇÇ Tracking
                    </span>
                </div>
            </div>
            
            <div class="chat-area">
                <div id="chat-box" class="chat-box"></div>
                
                <div class="input-container">
                    <div class="input-group">
                        <input type="text" id="user-input" placeholder="Type your message and press Enter..." />
                        <button onclick="sendMessage()" class="send-btn">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                        <button onclick="clearChat()" class="clear-btn">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                    <div class="input-hint">
                        <i class="fas fa-info-circle"></i> Press Enter to send ‚Ä¢ This chat is carbon-efficient
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let totalQueries = 0;
        let totalEmissions = 0;

        // ‚úÖ Add Enter key functionality
        document.getElementById("user-input").addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });

        // Focus input on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById("user-input").focus();
        });

        async function sendMessage() {
            const userInput = document.getElementById("user-input").value;
            const chatBox = document.getElementById("chat-box");

            if (!userInput.trim()) return;

            // Add user message with typing animation
            chatBox.innerHTML += `
                <div class="message user-message">
                    <div class="message-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">${userInput}</div>
                        <div class="message-time">${getCurrentTime()}</div>
                    </div>
                </div>
            `;
            
            document.getElementById("user-input").value = "";

            // Show typing indicator
            chatBox.innerHTML += `
                <div class="message bot-message typing-indicator">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;

            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: userInput })
                });

                const data = await response.json();
                
                // Remove typing indicator
                document.querySelector('.typing-indicator')?.remove();

                // Add bot response
                chatBox.innerHTML += `
                    <div class="message bot-message">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-text">${data.reply}</div>
                            <div class="message-time">${getCurrentTime()}</div>
                        </div>
                    </div>
                `;

                // ‚úÖ Handle emissions data
                let emissionsDisplay = "Not measured";
                let currentEmissions = 0;
                
                if (data.emissions !== null && data.emissions !== undefined) {
                    currentEmissions = Number(data.emissions);
                    emissionsDisplay = `${currentEmissions.toFixed(8)} kg CO‚ÇÇ`;
                    
                    // Update statistics
                    totalQueries++;
                    totalEmissions += currentEmissions;
                    updateStatistics(currentEmissions);
                }

                // Add emissions info
                chatBox.innerHTML += `
                    <div class="emissions-message">
                        <div class="emissions-icon">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <div class="emissions-content">
                            <span class="emissions-text">üåç Carbon Emissions: ${emissionsDisplay}</span>
                            <span class="emissions-save">Saving the planet, one query at a time!</span>
                        </div>
                    </div>
                `;

                // Auto-scroll to bottom
                chatBox.scrollTop = chatBox.scrollHeight;

            } catch (error) {
                document.querySelector('.typing-indicator')?.remove();
                chatBox.innerHTML += `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
            }
        }

        function updateStatistics(currentEmissions) {
            document.getElementById('total-queries').textContent = totalQueries;
            document.getElementById('total-emissions').textContent = totalEmissions.toFixed(8);
            
            // Calculate trees needed (approx 21kg CO‚ÇÇ per tree per year)
            const treesNeeded = (totalEmissions / 21).toFixed(4);
            document.getElementById('trees-equivalent').textContent = treesNeeded;
        }

        function clearChat() {
            document.getElementById("chat-box").innerHTML = "";
            totalQueries = 0;
            totalEmissions = 0;
            updateStatistics(0);
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>